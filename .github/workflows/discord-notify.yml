name: Discord Push Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Skip if no webhook configured
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL not set, skipping notification"
            exit 0
          fi

          # Build commit info
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1 | sed 's/"/\\"/g')
          AUTHOR="${{ github.event.head_commit.author.name }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Count files changed
          FILES_ADDED=${{ github.event.head_commit.added && join(github.event.head_commit.added, '\n') || '' }}
          FILES_MODIFIED=${{ github.event.head_commit.modified && join(github.event.head_commit.modified, '\n') || '' }}
          FILES_REMOVED=${{ github.event.head_commit.removed && join(github.event.head_commit.removed, '\n') || '' }}

          ADDED_COUNT=$(echo '${{ join(github.event.head_commit.added, '\n') }}' | grep -c . 2>/dev/null || echo 0)
          MODIFIED_COUNT=$(echo '${{ join(github.event.head_commit.modified, '\n') }}' | grep -c . 2>/dev/null || echo 0)
          REMOVED_COUNT=$(echo '${{ join(github.event.head_commit.removed, '\n') }}' | grep -c . 2>/dev/null || echo 0)

          FILES_SUMMARY=""
          [ "$ADDED_COUNT" -gt 0 ] 2>/dev/null && FILES_SUMMARY="${FILES_SUMMARY}+${ADDED_COUNT} added  "
          [ "$MODIFIED_COUNT" -gt 0 ] 2>/dev/null && FILES_SUMMARY="${FILES_SUMMARY}~${MODIFIED_COUNT} modified  "
          [ "$REMOVED_COUNT" -gt 0 ] 2>/dev/null && FILES_SUMMARY="${FILES_SUMMARY}-${REMOVED_COUNT} removed"
          FILES_SUMMARY="${FILES_SUMMARY:-No file info available}"

          # Send webhook
          curl -s -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"New Push to ${BRANCH}\",
                \"description\": \"\`${SHORT_SHA}\` ${COMMIT_MSG}\",
                \"url\": \"${COMMIT_URL}\",
                \"color\": 65535,
                \"fields\": [
                  {\"name\": \"Author\", \"value\": \"${AUTHOR}\", \"inline\": true},
                  {\"name\": \"Branch\", \"value\": \"\`${BRANCH}\`\", \"inline\": true},
                  {\"name\": \"Files\", \"value\": \"${FILES_SUMMARY}\", \"inline\": false}
                ],
                \"footer\": {\"text\": \"PULSAR SENTINEL \u2022 Post-Quantum Security\"},
                \"timestamp\": \"${TIMESTAMP}\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL"

          echo "Discord notification sent!"
